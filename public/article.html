<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨˜äº‹è©³ç´° - ä¼šè­°è³‡æ–™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        /* Markdownã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            font-weight: bold;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .markdown-content h1 { font-size: 2.25rem; }
        .markdown-content h2 { font-size: 1.5rem; }
        .markdown-content h3 { font-size: 1.25rem; }
        .markdown-content p { margin-top: 0.5rem; margin-bottom: 0.5rem; line-height: 1.625; }
        /* é»’ä¸¸ã®ç®‡æ¡æ›¸ã */
        .markdown-content ul { list-style-type: disc; list-style-position: inside; margin-left: 1rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        /* æ•°å­—ã®ç®‡æ¡æ›¸ã */
        .markdown-content ol { list-style-type: decimal; list-style-position: inside; margin-left: 1rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .markdown-content pre { background-color: #1a202c; color: white; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; margin-bottom: 1rem; overflow-x: auto; }
        .markdown-content code { background-color: #e2e8f0; color: #2d3748; padding: 0.25rem; border-radius: 0.25rem; }
        .markdown-content pre code { background-color: transparent; color: white; padding: 0; }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-500 to-purple-500 min-h-screen p-4 sm:p-6 lg:p-8 font-sans">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2/dist/purify.min.js"></script>
    <script>
        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã®å‹•çš„ãªå¤‰æ›´
        document.addEventListener('DOMContentLoaded', async () => {
            const navLinks = document.querySelector('.nav-links');
            if (navLinks) {
                try {
                    const response = await fetch('/api/auth_status');
                    const authStatus = await response.json();

                    if (authStatus.authenticated) {
                        // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆ
                        navLinks.innerHTML = `
                            <a href="/" class="py-2 px-4 rounded-lg text-white font-semibold hover:bg-gray-700 transition-colors duration-200">è³‡æ–™ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</a>
                            <a href="/documents" class="py-2 px-4 rounded-lg text-white font-semibold hover:bg-gray-700 transition-colors duration-200">è³‡æ–™ä¸€è¦§</a>
                            <a href="/knowledge" class="py-2 px-4 rounded-lg bg-blue-500 hover:bg-blue-600 text-white font-semibold transition-colors duration-200">ãƒŠãƒ¬ãƒƒã‚¸å…±æœ‰</a>
                            <div class="flex-grow"></div>
                            <a href="/knowledge/new" class="py-2 px-4 rounded-lg bg-green-500 hover:bg-green-600 text-white font-semibold transition-colors duration-200">æ–°ã—ã„è¨˜äº‹ã‚’ä½œæˆ</a>
                            <div class="text-white font-semibold flex items-center px-4">
                                ${authStatus.username}ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ä¸­
                            </div>
                            <a href="#" onclick="logout()" class="py-2 px-4 rounded-lg bg-red-500 hover:bg-red-600 text-white font-semibold transition-colors duration-200">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
                        `;
                    } else {
                        // æœªãƒ­ã‚°ã‚¤ãƒ³ã®å ´åˆ
                        navLinks.innerHTML = `
                            <div class="flex-grow"></div>
                            <a href="/login" class="py-2 px-4 rounded-lg bg-blue-500 hover:bg-blue-600 text-white font-semibold transition-colors duration-200">ãƒ­ã‚°ã‚¤ãƒ³</a>
                            <a href="/register" class="py-2 px-4 rounded-lg bg-green-500 hover:bg-green-600 text-white font-semibold transition-colors duration-200">æ–°è¦ç™»éŒ²</a>
                        `;
                    }
                } catch (error) {
                    console.error('èªè¨¼çŠ¶æ…‹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                }
            }
        });

        async function logout() {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                try {
                    await fetch('/api/logout', { method: 'POST' });
                    window.location.href = '/login';
                } catch (error) {
                    alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            }
        }
    </script>
    <div class="container max-w-4xl mx-auto bg-white rounded-xl shadow-2xl overflow-hidden">
        <header class="bg-gray-800 text-white p-6 sm:p-8 text-center">
            <h1 class="text-3xl sm:text-4xl font-light mb-2">è¨˜äº‹è©³ç´°</h1>
            <p class="text-gray-300 text-lg">ãƒŠãƒ¬ãƒƒã‚¸ã¨ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³</p>
        </header>

        <nav class="nav-links flex flex-wrap items-center gap-2 p-4 border-b border-gray-200 bg-gray-800 text-white sm:text-base text-sm"></nav>

        <main class="p-6 sm:p-8">
            <div id="message" class="hidden p-4 rounded-lg mb-4"></div>

            <div id="loading" class="text-center p-8 text-gray-600">
                <div class="w-8 h-8 border-4 border-gray-200 border-t-blue-500 rounded-full animate-spin mx-auto mb-2"></div>
                <div>èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>

            <article id="articleContainer" class="hidden">
                <header class="mb-8 pb-6 border-b-2 border-gray-200">
                    <h1 id="articleTitle" class="text-4xl font-bold text-gray-900 mb-4 leading-tight"></h1>
                    <div class="flex items-center justify-between text-gray-500 text-sm">
                        <span id="articleAuthor" class="font-medium text-blue-600"></span>
                        <span id="articleDate" class="italic"></span>
                    </div>
                </header>

                <div id="articleContent" class="markdown-content text-gray-800 text-lg leading-relaxed mb-10"></div>

                <section class="comments-section border-t-2 border-gray-200 pt-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center space-x-2">
                        ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ <span id="commentCount" class="text-xl text-gray-500">(0)</span>
                    </h2>

                    <div class="comment-form bg-gray-50 rounded-xl p-6 shadow-inner mb-8">
                        <form id="commentForm">
                            <div class="mb-4">
                                <label for="commentContent" class="block text-gray-700 font-bold mb-2">ã‚³ãƒ¡ãƒ³ãƒˆ</label>
                                <textarea id="commentContent" name="content" required placeholder="ã“ã®è¨˜äº‹ã«ã¤ã„ã¦ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚„è³ªå•ã‚’ãŠæ›¸ããã ã•ã„..." class="w-full h-32 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow duration-200 font-sans text-base resize-y"></textarea>
                            </div>
                            <button type="submit" id="submitBtn" class="w-full sm:w-auto py-3 px-6 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold rounded-lg shadow-lg hover:from-blue-600 hover:to-blue-700 transform hover:scale-105 transition-all duration-300 focus:outline-none">
                                ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
                            </button>
                        </form>
                    </div>

                    <div id="commentsList" class="space-y-4">
                        <div id="noComments" class="text-center p-8 text-gray-500 hidden italic">
                            ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
                        </div>
                    </div>
                </section>
            </article>
        </main>
    </div>

    <script>
        let articleId = null;

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è¨˜äº‹è©³ç´°ã‚’å–å¾—
        document.addEventListener('DOMContentLoaded', () => {
            // URLã‹ã‚‰è¨˜äº‹IDã‚’å–å¾—
            const pathParts = window.location.pathname.split('/');
            articleId = pathParts[pathParts.length - 1];
            
            if (articleId) {
                loadArticle();
                loadComments();
            }

            // ã‚³ãƒ¡ãƒ³ãƒˆãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
            const commentForm = document.getElementById('commentForm');
            commentForm.addEventListener('submit', submitComment);
        });

        async function loadArticle() {
            const loading = document.getElementById('loading');
            const articleContainer = document.getElementById('articleContainer');
            
            loading.classList.remove('hidden');
            articleContainer.classList.add('hidden');
            
            try {
                const response = await fetch(`/api/articles/${articleId}`);
                
                if (!response.ok) {
                    throw new Error('è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                const article = await response.json();
                
                document.getElementById('articleTitle').textContent = article.title;
                document.getElementById('articleAuthor').textContent = `by ${article.author}`;
                document.getElementById('articleDate').textContent = formatDate(article.created_at);
                
                // Markdownã‚’HTMLã«å¤‰æ›ã—ã€XSSå¯¾ç­–ã‚’æ–½ã—ã¦è¡¨ç¤º
                const markdownContent = marked.parse(article.content);
                const sanitizedHtml = DOMPurify.sanitize(markdownContent);
                document.getElementById('articleContent').innerHTML = sanitizedHtml;
                
                // ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
                document.title = `${article.title} - ä¼šè­°è³‡æ–™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ `;
                
                articleContainer.classList.remove('hidden');
            } catch (error) {
                showMessage('è¨˜äº‹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
            
            loading.classList.add('hidden');
        }

        async function loadComments() {
            try {
                const response = await fetch(`/api/articles/${articleId}/comments`);
                const comments = await response.json();
                
                displayComments(comments);
                updateCommentCount(comments.length);
            } catch (error) {
                console.error('ã‚³ãƒ¡ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
            }
        }

        function displayComments(comments) {
            const commentsList = document.getElementById('commentsList');
            const noComments = document.getElementById('noComments');
            
            if (comments.length === 0) {
                noComments.classList.remove('hidden');
                return;
            }
            
            noComments.classList.add('hidden');
            
            commentsList.innerHTML = '';
            
            comments.forEach(comment => {
                const commentDiv = document.createElement('div');
                commentDiv.className = 'bg-gray-100 rounded-lg p-4 shadow-sm';
                
                commentDiv.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <div class="font-semibold text-gray-800">${escapeHtml(comment.author)}</div>
                        <div class="text-xs text-gray-500">${formatDate(comment.created_at)}</div>
                    </div>
                    <p class="text-gray-700 leading-relaxed">${escapeHtml(comment.content)}</p>
                `;
                
                commentsList.appendChild(commentDiv);
            });
        }

        function updateCommentCount(count) {
            const commentCount = document.getElementById('commentCount');
            commentCount.textContent = `(${count})`;
        }

        async function submitComment(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const commentData = {
                content: formData.get('content')
            };
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'æŠ•ç¨¿ä¸­...';
            
            try {
                const response = await fetch(`/api/articles/${articleId}/comments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(commentData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage(result.message, 'success');
                    document.getElementById('commentForm').reset();
                    loadComments(); // ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
                } else {
                    showMessage(result.error || 'ã‚³ãƒ¡ãƒ³ãƒˆã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                showMessage('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
            
            submitBtn.disabled = false;
            submitBtn.textContent = 'ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${year}/${month}/${day} ${hours}:${minutes}`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showMessage(text, type) {
            const message = document.getElementById('message');
            message.textContent = text;
            if (type === 'success') {
                message.className = 'bg-green-100 text-green-700 p-4 rounded-lg mb-4';
            } else if (type === 'error') {
                message.className = 'bg-red-100 text-red-700 p-4 rounded-lg mb-4';
            }
            message.classList.remove('hidden');
            
            setTimeout(() => {
                message.classList.add('hidden');
            }, 5000);
        }
    </script>
</body>
</html>
